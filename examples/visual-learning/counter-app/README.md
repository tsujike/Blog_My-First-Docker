# Counter App - データの永続化を視覚的に理解する

このサンプルは、**ボリュームを使ったデータの永続化**を視覚的に確認するための例です。

## このサンプルで学ぶこと

- ボリュームの必要性を理解
- データの永続化を視覚的に確認
- コンテナを削除してもデータが残ることを確認
- データベースとボリュームの関係を理解

## ファイル構成

```
counter-app/
├── README.md
├── docker-compose.yml
├── app/
│   └── index.php      # PHPアプリケーション
└── init.sql          # データベースの初期化SQL
```

## 手順

### ステップ1：アプリケーションを起動する

```bash
docker-compose up -d
```

**何が起こるか：**
1. MySQLコンテナが起動する
2. PHPアプリケーションコンテナが起動する
3. データベースが初期化される
4. カウンターが0から始まる

### ステップ2：ブラウザで確認する

ブラウザで以下のURLにアクセス：
```
http://localhost:8080
```

**確認ポイント：**
- カウンターが表示される
- 「カウントアップ」ボタンをクリック
- 数字が増えることを確認

### ステップ3：データが保存されていることを確認する

**確認コマンド：**
```bash
# データベースに接続してデータを確認
docker exec -it counter-app-db-1 mysql -u root -prootpass counter_db -e "SELECT * FROM counter;"
```

**確認ポイント：**
- データベースにデータが保存されている
- カウンターの値がデータベースに記録されている

### ステップ4：コンテナを停止・削除する

```bash
# コンテナを停止
docker-compose stop

# コンテナを削除（ボリュームは残す）
docker-compose down
```

**確認ポイント：**
- コンテナが削除される
- `docker ps -a`でコンテナが表示されなくなる

### ステップ5：ボリュームを確認する

```bash
# ボリューム一覧を確認
docker volume ls

# ボリュームの詳細を確認
docker volume inspect counter-app_db_data
```

**確認ポイント：**
- `counter-app_db_data`というボリュームが存在する
- ボリュームが残っている

### ステップ6：コンテナを再作成する

```bash
docker-compose up -d
```

**確認ポイント：**
- ブラウザで再度アクセス
- **カウンターの値が残っている**（データが永続化されている）

### ステップ7：ボリュームを削除して再作成する

```bash
# コンテナとボリュームを削除
docker-compose down -v

# 再作成
docker-compose up -d
```

**確認ポイント：**
- カウンターが0にリセットされる
- データが消えている

## 視覚的に確認すべきポイント

### 1. データの永続化

**確認方法：**
- カウンターを増やす
- コンテナを削除
- コンテナを再作成
- カウンターの値が残っていることを確認

**理解すべきこと：**
- ボリュームを使うことで、データが永続化される
- コンテナを削除しても、ボリュームのデータは残る

### 2. ボリュームの存在

**確認方法：**
- `docker volume ls`でボリュームを確認
- `docker volume inspect`でボリュームの詳細を確認

**理解すべきこと：**
- ボリュームは独立した存在
- コンテナとは別に管理される

### 3. データベースとボリュームの関係

**確認方法：**
- データベースのデータを確認
- ボリュームの場所を確認

**理解すべきこと：**
- データベースのデータはボリュームに保存される
- ボリュームを削除すると、データも消える

## トラブルシューティング

### データベースに接続できない

**確認事項：**
1. コンテナが起動しているか確認（`docker-compose ps`）
2. データベースが完全に起動するまで待つ（初回起動時は時間がかかります）
3. ログを確認（`docker-compose logs db`）

### カウンターがリセットされる

**確認事項：**
1. ボリュームが作成されているか確認（`docker volume ls`）
2. `docker-compose down -v`を実行していないか確認
3. ボリュームが削除されていないか確認

## 次のステップ

このサンプルでデータの永続化を理解したら、次は以下を試してみましょう：

1. **WordPress環境構築** - より実践的な例
2. **MySQL学習環境構築** - データベースの詳細な使い方

## まとめ

- ボリュームを使うことで、データを永続化できる
- コンテナを削除しても、ボリュームのデータは残る
- ボリュームを削除すると、データも消える
- データベースのデータは、ボリュームに保存される

実際に手を動かしながら、データの永続化を視覚的に確認することで、理解が深まります！

