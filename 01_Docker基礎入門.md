# 【Docker入門】ノンプログラマーでもわかる！Dockerの基礎知識

どうも、ケニー（tsujikenzo）です。今日は「Dockerの基礎知識」についてお送りします。

## はじめに

これまで、Google Apps Script（GAS）やVBAでローコードアプリを作成したり、FTPサーバーに簡単なWEBサイトをアップロードする程度のことをしてきました。しかし、WordPressやSQLを使ったアプリケーションを作成する際に、どうしてももう一段階スキルを上げる必要があると感じました。

そこで、**仮想環境を作る**ということにチャレンジしてみたいと思います。Docker Desktopのインストールは完了しているので、そこから先を学んでいきましょう。

**この記事を読む前に：**
- [アプリが動く仕組み](./00_アプリが動く仕組み.md)を読むことをおすすめします
- アプリが動くために必要なものを理解することで、Dockerの必要性がより明確になります

## Dockerとは？

**Docker（ドッカー）は、アプリを簡単に動かすためのツールです。**

もっと具体的に言うと：

- **アプリを作る**：アプリとその実行環境を一緒にパッケージ化する
- **アプリを運ぶ**：Macで作ったアプリを、WindowsやLinuxでも動かせる
- **アプリを動かす**：どこでも同じように動く

**従来の問題：**
- 「Macで動いたのに、Windowsで動かない」
- 「環境構築に時間がかかる」
- 「開発環境と本番環境で動作が違う」

**Dockerの解決方法：**
- アプリとその実行環境を一緒にパッケージ化する
- 環境ごとアプリを運ぶことで、どこでも同じように動く
- 環境構築が簡単になる

**簡単に言うと：**
Dockerは、**環境ごとアプリを運ぶ**ことで、**どこでも同じように動かせる**ツールです。

### Dockerの特徴

Dockerは、**コンテナ（container）という緩やかに隔離された環境**で、アプリケーションのパッケージ化と実行をする機能を提供します。

**主な特徴：**
- **環境ごとアプリを運ぶ**：アプリケーションとその実行環境を一緒にパッケージ化する
- **OSに依存しない**：Mac、Windows、Linuxなど、どのOSでも同じように動く
- **軽量**：コンテナは軽量であり、アプリケーションの実行に必要な全てが入っている
- **独立性**：ホスト上で今何をインストールしていようが関係ない
- **共有性**：作業中でも手軽にコンテナを共有できる
- **一貫性**：同じコンテナを、同じ方法で、確実に動作できる

### なぜDockerが必要なのか？

**アプリが動くために必要なもの**（詳しくは[アプリが動く仕組み](./00_アプリが動く仕組み.md)を参照）：
- OS（Windows、Mac、Linuxなど）
- ランタイム環境（Python、PHP、Node.jsなど）
- ライブラリ（Flask、requests、expressなど）
- 設定ファイル（データベース接続情報など）
- データベース（必要な場合）

従来、アプリケーションを動かすには以下のような問題がありました：

- **環境の違い**：「自分のPCでは動いたのに、他のPCでは動かない」
- **OSの違い**：「Macでは動いたのに、Windowsでは動かない」「Linuxでは動いたのに、Macでは動かない」
- **依存関係の複雑さ**：「このバージョンのPythonが必要」「このライブラリが必要」
- **セットアップの手間**：「環境構築に1日かかった」
- **デプロイの複雑さ**：テスト環境と本番環境で動作が異なる

**Dockerの解決方法：**
Dockerは、**アプリケーションとその実行環境を一緒にパッケージ化**します。つまり、**環境ごとアプリを運ぶ**イメージです。

```
アプリ + OS + ランタイム + ライブラリ + 設定ファイル
    ↓
コンテナ（環境ごとアプリ）
    ↓
どこでも動く！
```

- Macで作ったアプリ → Windowsでも動く
- Windowsで作ったアプリ → Linuxでも動く
- Linuxで作ったアプリ → Macでも動く

**環境に依存しない**、むしろ**環境ごとアプリを運ぶ**ことで、どこでも同じように動かせます。

### Dockerの用途

#### 1. 素早く一貫性を保つアプリケーションのデリバリ

Dockerは開発のライフサイクルを効率化します。開発するアプリケーションやサービスがローカルなコンテナ内に実現でき、開発者は標準化された環境により作業が進められます。

**開発フローの例：**
1. 開発者がローカルでコードを書き、Dockerコンテナで共有
2. Dockerによりアプリケーションをテスト環境に投入し、テストを実行
3. バグを発見したら、開発環境で修正し、テスト環境に再デプロイ
4. テスト完了後、更新済みイメージを本番環境へ投入

#### 2. 迅速なデプロイとスケーリング

Dockerコンテナは、開発者のノートパソコン上で実行できるだけでなく、データセンタの物理マシンや仮想マシン、クラウドプロバイダ、そしてさまざまな環境の組み合わせにおいて実行可能です。

**環境に依存しない実行：**
- **Macで開発** → Windowsでテスト → Linuxで本番環境
- **Windowsで開発** → Macでテスト → クラウドで本番環境
- **Linuxで開発** → Macでテスト → Windowsでデモ

どのOSでも、同じコンテナが同じように動きます。**環境ごとアプリを運ぶ**ことで、環境の違いを気にせずに開発・デプロイできます。

#### 3. 同じハードウェア上で負荷の高い処理を実行

Dockerは軽量かつ高速です。ハイパーバイザ・ベースの仮想マシンに取って変わる、実用的で費用対効果の高いものです。サーバ性能をフルに活用してビジネス目標を達成できます。

### Dockerの重要な4つの用語

Dockerを理解する上で、**Repository（リポジトリ）**、**Image（イメージ）**、**Container（コンテナ）**、**Volumes（ボリューム）**の4つの用語を理解することが重要です。

#### 1. リポジトリ（Repository）
イメージを保存・管理する**場所**です。
- **Docker Hub**が最も有名なリポジトリ（例：https://hub.docker.com/）
- イメージをダウンロード（pull）したり、アップロード（push）したりする場所
- 例：`nginx`、`wordpress`、`mysql`などがリポジトリ名

**リポジトリ名の形式：**
```
ユーザー名/リポジトリ名:タグ
```
- 例：`nginx:latest`、`wordpress:5.9`、`mysql:8.0`
- タグを省略すると`latest`（最新版）が使われます

#### 2. イメージ（Image）
**コンテナイメージ（Container Image）**は、コンテナのファイルシステムを提供するものです。

コンテナを実行すると、コンテナは**隔離されたファイルシステム**を使います。この特別なファイルシステムは、コンテナイメージによって提供されます。

**イメージに含まれるもの：**
- アプリケーションの実行に必要な全て（依存関係、設定ファイル、スクリプト、バイナリなど）
- 環境変数、デフォルトで実行するコマンド、メタデータなどの設定

**イメージの特徴：**
- 読み取り専用（変更できない）
- 1つのイメージから複数のコンテナを作成できる
- 階層構造になっている（レイヤー）
- Dockerfileの各命令ごとにレイヤーが生成される

#### 3. コンテナ（Container）
**コンテナ（container）とはマシン上でサンドボックス化したプロセス**であり、ホストマシン上にある他すべてのプロセスから**隔離（isolate）**されています。

コンテナは、**イメージの実行可能な実体（インスタンス）**です。

**コンテナの技術的な仕組み：**
- コンテナの隔離は、**カーネルの名前空間（namespaces）とcgroup**の活用によって実現されています
- chrootの拡張バージョンと考えることができます
- ファイルシステムはイメージから由来しますが、単純なchrootではできない付加的な隔離を追加します

**コンテナの特徴：**
- **イメージの実行可能な実体**：Docker APIやCLIを使い、作成、開始、停止、移動、削除ができます
- **読み書き可能**：イメージ（読み取り専用）の上に、読み書き可能なレイヤーが追加されます
- **独立して動作**：他のコンテナやホストマシンのプロセスから隔離されています
- **環境に依存しない実行**：Mac、Windows、Linuxなど、どのOSでも同じように動く
- **環境ごとアプリを運ぶ**：アプリケーションとその実行環境が一緒にパッケージ化されている
- **可搬性**：ローカルマシン、仮想マシン、クラウドなど、多くの環境で実行できます
- **一時的**：コンテナを削除すると、読み書き可能なレイヤーも削除されます

#### 4. ボリューム（Volumes）
コンテナのデータを永続化するための**仕組み**です。
- コンテナを削除してもデータが残る
- データベースのデータ、アップロードされたファイルなどを保存
- 名前付きボリュームとバインドマウントの2種類がある

**ボリュームの特徴：**
- データを永続化できる（コンテナ削除後も残る）
- 複数のコンテナで共有可能
- バックアップや移行が簡単

### 4つの関係を理解しよう

```
リポジトリ（Docker Hubなど）
    ↓ docker pull
イメージ（設計図）
    ↓ docker run
コンテナ（実際に動くアプリ）
    ↓ volumes（マウント）
ボリューム（データを永続化）
```

**具体例：**
1. **リポジトリ**：Docker Hubに`mysql:8.0`が保存されている
2. **イメージ**：`docker pull mysql:8.0`でローカルにダウンロード
3. **コンテナ**：`docker run mysql`で実際にMySQLサーバーが起動
4. **ボリューム**：`-v mysql_data:/var/lib/mysql`でデータベースのデータを永続化

### Dockerfileについて

**Dockerfile**は、イメージを作成するための**レシピ**です。
- どのOSを使うか
- どのソフトウェアをインストールするか
- どのファイルをコピーするか

を記述します。

**Dockerfileからイメージを作成：**
```
Dockerfile（レシピ）
    ↓ docker build
イメージ（設計図）
    ↓ docker run
コンテナ（実際に動くアプリ）
```

## Dockerの基本構造を理解しよう

### リポジトリ → イメージ → コンテナの流れ

```
リポジトリ（Docker Hub）
    ↓ docker pull
イメージ（設計図）
    ↓ docker run
コンテナ（実際に動くアプリ）
```

### Dockerfileからイメージを作る流れ

```
Dockerfile（レシピ）
    ↓ docker build
イメージ（設計図）
    ↓ docker run
コンテナ（実際に動くアプリ）
```

### 具体例で理解する

**料理に例えると：**
- **リポジトリ** = レシピが保存されている本棚（Docker Hub）
- **イメージ** = レシピ本を元に作られた完成品の写真（保存されている状態）
- **コンテナ** = 実際に作られた料理（食べられる状態、実行中）
- **Dockerfile** = 自分で書いたレシピ

**もう少し詳しく：**
- **リポジトリ**：レシピが集まっている場所（Docker Hub = 大きなレシピ図書館）
- **イメージ**：レシピを元に作った完成品の写真。写真は何枚でもコピーできる
- **コンテナ**：写真を見ながら実際に作った料理。食べるとなくなる（停止・削除）
- **ボリューム**：冷蔵庫のようなもの。料理を保存しておけば、後でまた使える（データを永続化）

### 実際のコマンド例

```bash
# 1. リポジトリからイメージを取得
docker pull mysql:8.0

# 2. イメージの一覧を確認
docker images

# 3. ボリューム付きでコンテナを作成・起動
docker run -d \
  -e MYSQL_ROOT_PASSWORD=rootpass \
  -v mysql_data:/var/lib/mysql \
  --name my-mysql \
  mysql:8.0

# 4. 実行中のコンテナを確認
docker ps

# 5. ボリュームの確認
docker volume ls

# 6. コンテナを停止
docker stop my-mysql

# 7. コンテナを削除（ボリュームは残る）
docker rm my-mysql

# 8. 同じボリュームで新しいコンテナを起動（データが残っている）
docker run -d \
  -e MYSQL_ROOT_PASSWORD=rootpass \
  -v mysql_data:/var/lib/mysql \
  --name my-mysql2 \
  mysql:8.0
```

## Dockerのアーキテクチャ

Dockerは**クライアント・サーバ型のアーキテクチャ**を採用しています。

### Dockerの主要コンポーネント

```
┌─────────────────┐
│ Docker クライアント │
│   (docker)      │
└────────┬────────┘
         │ REST API
         ↓
┌─────────────────┐
│ Docker デーモン   │
│   (dockerd)     │
└─────────────────┘
         │
         ├─→ イメージ管理
         ├─→ コンテナ管理
         ├─→ ネットワーク管理
         └─→ ボリューム管理
```

#### 1. Dockerデーモン（dockerd）

Dockerデーモンは、Docker APIリクエストを受け付け、イメージ、コンテナ、ネットワーク、ボリュームといったDockerオブジェクトを管理します。

**役割：**
- イメージの管理
- コンテナの構築、実行、配布
- ネットワークとボリュームの管理
- Dockerサービスを管理するため、他のデーモンとも通信

#### 2. Dockerクライアント（docker）

Dockerクライアントは、Dockerとのやりとりを行うために、たいていのユーザが利用するものです。

**役割：**
- `docker run`のようなコマンドを実行
- Dockerデーモンにコマンドを伝える
- Docker APIを利用
- 複数のデーモンと通信可能

**例：**
```bash
docker run nginx
```
このコマンドを実行すると、DockerクライアントがDockerデーモンに「nginxコンテナを起動して」と伝えます。

#### 3. Docker Desktop

Docker Desktopは、Mac、Windows、Linux環境へ簡単にインストールできるアプリケーションです。

**含まれるもの：**
- Dockerデーモン（dockerd）
- Dockerクライアント（docker）
- Docker Compose
- Docker Content Trust
- Kubernetes
- Credential Helper（認証情報ヘルパー）

**Windowsでの動作：**
- Windows上でDocker Desktopを起動すると、WSL2（Windows Subsystem for Linux）上でDockerデーモンが動作します

#### 4. Dockerレジストリ（Registry）

Dockerレジストリは、Dockerイメージを保管します。

**主なレジストリ：**
- **Docker Hub**：公開レジストリであり、誰でも利用可能（デフォルト）
- **プライベートレジストリ**：独自に運用することも可能

**コマンド：**
- `docker pull`：レジストリからイメージを取得
- `docker push`：イメージをレジストリに送信

### Dockerクライアントとデーモンの通信

Dockerクライアントとデーモンは：
- **同一システム上で動かすことも可能**（通常の使い方）
- **別のシステム上であっても、リモートアクセスが可能**

通信にはREST APIが利用され、UNIXソケットまたはネットワークインターフェイスを介して行われます。

## Docker Desktopの確認

まず、Docker Desktopが正しく動いているか確認しましょう。

### 1. Docker Desktopを起動

Windowsのスタートメニューから「Docker Desktop」を起動してください。

### 2. 動作確認

コマンドプロンプトまたはPowerShellで以下のコマンドを実行：

```bash
docker --version
```

以下のような表示が出ればOKです：
```
Docker version 24.0.0, build xxxxxx
```

### 3. Hello Worldで動作確認

Dockerが正しく動いているか、最も簡単な方法で確認します：

```bash
docker run hello-world
```

初回実行時は、イメージをダウンロードしてから実行されます。以下のようなメッセージが表示されれば成功です：

```
Hello from Docker!
This message shows that your installation appears to be working correctly.
```

## 次のステップ

次回は、実際にDockerを使って簡単なアプリケーションを動かしてみましょう。

- [ ] Dockerの基本コマンドを覚える
- [ ] 簡単なWebアプリケーションをコンテナで動かす
- [ ] WordPressをDockerで動かす
- [ ] データベース（MySQL）をDockerで動かす

## Dockerの基礎技術

Dockerは**Goプログラミング言語**で書かれており、**Linuxカーネルの機能**をうまく活用して、さまざまな機能性を実現しています。

### Namespaces（名前空間）とcgroup

Dockerは**namespaces（名前空間）**と**cgroup**というLinuxカーネルの機能を活用して、コンテナの隔離を実現しています。

#### Namespaces（名前空間）

Dockerは**namespaces（名前空間）**技術を使い、「コンテナ」と呼ぶ**隔離された作業空間（isolated workspace）**を準備します。

**名前空間の役割：**
- コンテナ内のさまざまな処理は、隔離された名前空間内で実行される
- それぞれへのアクセスはその名前空間内に限定される
- 複数の隔離状態を作り出すことで、コンテナ間の独立性を保つ

**名前空間の種類：**
- **PID名前空間**：プロセスIDの隔離
- **ネットワーク名前空間**：ネットワークインターフェースの隔離
- **マウント名前空間**：ファイルシステムの隔離
- **UTS名前空間**：ホスト名の隔離
- **IPC名前空間**：プロセス間通信の隔離
- **ユーザー名前空間**：ユーザーIDの隔離

#### cgroup（Control Groups）

cgroupは、プロセスグループのリソース使用量を制限・監視する機能です。

**cgroupの役割：**
- CPU、メモリ、ディスクI/Oなどのリソース使用量を制限
- リソース使用量を監視
- 複数のコンテナが同じホスト上で動作する際のリソース管理

これにより、コンテナは互いに影響を与えずに動作でき、リソースも適切に管理されます。

## まとめ

- Dockerは、アプリを簡単に動かすためのツール（環境ごとアプリを運ぶことで、どこでも同じように動かせる）
- Dockerは**クライアント・サーバ型のアーキテクチャ**を採用している
  - **Dockerデーモン（dockerd）**：イメージ、コンテナ、ネットワーク、ボリュームを管理
  - **Dockerクライアント（docker）**：ユーザーがコマンドを実行するインターフェース
  - **Docker Desktop**：Mac、Windows、Linux向けの統合アプリケーション
  - **Dockerレジストリ**：Dockerイメージを保管（Docker Hubがデフォルト）
- **リポジトリ（Repository）**：イメージを保存・管理する場所（Docker Hubなど）
- **イメージ（Image）**：アプリケーションを動かすための設計図（読み取り専用）
- **コンテナ（Container）**：イメージから作られた実際に動いているアプリケーション（読み書き可能）
- **ボリューム（Volumes）**：コンテナのデータを永続化する仕組み（コンテナ削除後も残る）
- Dockerは**namespaces（名前空間）**技術を使って、コンテナを隔離している
- リポジトリ → イメージ → コンテナ → ボリュームの流れを理解することが重要
- Docker Desktopが正しく動いているか確認できた

次回は、実際に手を動かしながらDockerの基本コマンドを学んでいきましょう！

---

**参考リンク**
- [Docker公式ドキュメント（日本語）](https://docs.docker.jp/)
- [Docker概要（公式）](https://docs.docker.jp/get-started/overview/) - Dockerとは何かの公式説明
- [Docker Hub](https://hub.docker.com/) - 様々なイメージが公開されています
- [Docker Desktop](https://www.docker.com/products/docker-desktop/) - Docker Desktopの公式サイト

